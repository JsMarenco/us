---
// Third-party dependencies

// Current project dependencies
import Layout from "../../layouts/Main.astro";
import prisma from "../../lib/prisma";
import UserProfile from "../../components/Views/UserProfile/index.astro";

export const prerender = false;
// eslint-disable-next-line astro/no-exports-from-components
export const ssr = true;

const { username } = Astro.params;

const user = await prisma.user.findFirst({
  where: {
    username: {
      equals: username?.toString(),
      mode: "insensitive",
    },
  },
});

if (!user) {
  return Astro.redirect("/de-yo-pa-tu");
}

const { firstName, lastName, bio } = user;

const allDeYoPaTus = await prisma.deYoPaTu.findMany({
  where: { creatorId: user.id },
});

const createdDeYoPaTus = allDeYoPaTus.filter(
  (deYoPaTu) => deYoPaTu.isAnonymous === false || deYoPaTu.isAnonymous === null,
);
---

<Layout
  description={bio ||
    `DeYoPaTus creados por ${firstName || lastName ? `${firstName ?? ""} ${lastName ?? ""}`.trim() : username}.`}
  image={`/api/users/${username}/og`}
  title={`${firstName || lastName ? `${firstName ?? ""} ${lastName ?? ""}`.trim() : username} (@${username})`}
>
  <UserProfile createdDeYoPaTus={createdDeYoPaTus} user={user} />
</Layout>
